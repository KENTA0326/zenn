---
title: "é€šå ±æ©Ÿèƒ½"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [rails]
published: true
---
# ã¯ã˜ã‚ã«
ã€€å‰ã«ã‚„ã£ã¦ã¾ã¨ã‚ãã‚Œã¦ã„ãªã‹ã£ãŸé€šå ±ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã‚¤ãƒ¡ãƒ¼ã‚¸
ã€€é€šå ±ã™ã‚‹å´ã¨ã•ã‚Œã‚‹å´ã€å®Ÿè£…ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ãƒ•ã‚©ãƒ­ãƒ¼ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã¨åŒã˜æ„Ÿã˜ã§ã™ã€‚

* reportãƒ†ãƒ¼ãƒ–ãƒ«
```
t.integer :reporter_id
t.integer :reported_id
t.text :reason, null: false
t.boolean :checked, default: false

```
reporter_id :é€šå ±ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
reported_id :é€šå ±ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
reason :é€šå ±ç†ç”±(å†…å®¹)
checkedï¼šç®¡ç†è€…ãŒã®ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼šfalseï¼‰

* userãƒ†ãƒ¼ãƒ–ãƒ«
```
t.integer "user_status", default: 0
```

* enum
```
class User < ApplicationRecord
  enum status: { available: 0, suspended: 1 }
end
```

* ja.yml
```
ja:
    datetime:
      distance_in_words:
        x_days: "%{count}æ—¥"

#ã“ã“ã‹ã‚‰ï¼
    enums:
      user:
        user_status:
          available: "åˆ©ç”¨å¯èƒ½"
          suspended: "åˆ©ç”¨åœæ­¢ä¸­"
```


## ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
```html:user.rb
has_many :reporter, class_name: "Report", foreign_key: "reporter_id", dependent: :destroy
has_many :reported, class_name: "Report", foreign_key: "reported_id", dependent: :destroy
```

```html.report.rb
belongs_to :reporter, class_name: "User"
belongs_to :reported, class_name: "User"

# reporter_idãŒuser_idã§ã‚ã‚‹é€šå ±ã®ä»¶æ•°ã‚’è¿”ã™ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰(ã“ã“ã‚’è¿½è¨˜)
  def self.reported_count(user_id)
    where(reported_id: user_id).count
  end
```

## ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```
resources :users, only: [:index, :show, :edit, :update] do
        post "profile/:user_id/report" => "reports#create", as: "profile_report"
        get "profile/:user_id/report/new" => "reports#new", as: "profile_reports_new"
      end

namespace :admin do
    get 'reports/index'
    get 'reports/show'
  end
```

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
```html:public /reports_controller
class Public::ReportsController < ApplicationController
  def new
    @report = Report.new
    @user = User.find(params[:user_id])
  end

  def create
    @user = User.find(params[:user_id])
    @report = Report.new(report_params)
    @report.reporter_id = current_user.id
    @report.reported_id = @user.id

    if @report.save
      redirect_to user_path(@user)
    else
      render "new"
    end
  end

  private

  def report_params
    params.require(:report).permit(:reason)
  end

end

```

 @report.reporter_id = current_user.id
 é€šå ±è€…(reporter_id)ã«ä»Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼

 @report.reported_id = @user.id
 é€šå ±ã•ã‚Œã‚‹äºº(reported_id)ã«å®šç¾©ã—ãŸ@user.idã‚’ä»£å…¥

 ```html:admin/reports_controller
 class Admin::ReportsController < ApplicationController
  def index
    @reports = Report.all
  end

  def show
    @report = Report.find(params[:id])
  end

  def update
    @report = Report.find(params[:id])
    if @report.update(report_params)
      redirect_to admin_reports_path
    end
  end

  private

  def report_params
    params.require(:report).permit(:checked)
  end

end

```

## viewã®ä½œæˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼
* é€šå ±ãƒœã‚¿ãƒ³
```
<% if @user != current_user %>
ã€€<% if current_user.reporter.exists?(reported_id: @user.id) %>
ã€€ã€€<%= button_tag "é€šå ±æ¸ˆã¿", class: "btn btn-secondary", disabled: true %>
  <% else %>
  ã€€<%= link_to "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€šå ±", user_profile_reports_new_path(@user), class: "btn btn-danger" %>
  <% end %>
<% end %>
```
è‡ªåˆ†ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã‹ã¤äºŒåº¦ç›®ã¯é€šå ±ã—ãªã„ã‚ˆã†ã«è¨­å®šã€‚

```html:report/new.html.erb
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <h3 class="text-center">é€šå ±</h3>
      <p class="text-center">é€šå ±ç†ç”±ã‚’ä»¥ä¸‹ã«ã”è¨˜å…¥ãã ã•ã„ã€‚</p>
      <%= form_with model:[@user, @report],url: user_profile_report_path(@user), class: "my-4" do |f| %>
        <div class="form-group d-flex justify-content-center">
          <%= f.text_area :reason, rows:'3', class:"form-control" %>
        </div>
        <div class="form-group d-flex justify-content-center">
          <%= f.submit "é€šå ±ã™ã‚‹", class: "btn btn-danger" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
```

### ç®¡ç†è€…

* view
```html:admin/report/index.html.erb
<h2 class="heading heading-1">é€šå ±ä¸€è¦§</h2>
<div class="card">
  <div class="card-body">
    â€»ç•ªå·ã‹ã‚‰é€šå ±è©³ç´°ã¸é£›ã³ã¾ã™ã€‚
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>é€šå ±ID</th>
            <th>é€šå ±æ—¥</th>
            <th>ä¼šå“¡å</th>
            <th>é€šå ±è€…</th>
            <th>é€šå ±ã•ã‚ŒãŸå›æ•°</th>
            <th>ç®¡ç†è€…check</th>
          </tr>
        </thead>
        <tbody>
          <% @reports.each do |report| %>
            <tr>
              <td><%= link_to report.id, admin_report_path(report) %></td>
              <td><%= report.created_at %></td>
              <td><%= report.reported.name %></td>
              <td><%= report.reporter.name %></td>
              <td><%= Report.where(reported_id: report.reported_id).count %></td>
              <td>
                <% if report.checked %>
                  <span class="badge badge-success">ç¢ºèªæ¸ˆã¿</span>
                <% else %>
                  <span class="badge badge-danger">æœªç¢ºèª</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
```



```html:admin/report/shoe.index.htnl.erb
<h2 class="heading heading-1">é€šå ±è©³ç´°</h2>
<div class="card mx-auto mt-5" style="width: 500px;">
  <div class="card-body">
    <div class="row">
      <div class="col-6"><strong>é€šå ±ID</strong></div>
      <div class="col-6"><%= link_to @report.id %></div>
    </div>
    <div class="row">
      <div class="col-6"><strong>ä¼šå“¡å</strong></div>
      <div class="col-6"><%= link_to @report.reported.name, admin_user_path(@report.reported_id) %></div>
    </div>
    <div class="row">
      <div class="col-6"><strong>ç†ç”±</strong></div>
      <div class="col-6"><%= @report.reason %></div>
    </div>
    <div class="row">
      <div class="col-6"><strong>é€šå ±è€…</strong></div>
      <div class="col-6"><%= @report.reporter.name %></div>
    </div>
    <div class="row">
      <div class="col-6"><strong>å¯¾å¿œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong></div>
      <div class="col-6">
        <%= form_with model:@report, url:admin_report_path(@report), method: :patch, local: true do |f| %>
          <div class="form-group text-center">
            <%= f.select :checked, { "æœªç¢ºèª": false, "ç¢ºèªæ¸ˆã¿": true }, {}, class: "form-control" %>
          </div>
          <%= f.button 'æ›´æ–°', class: "contact-edit-user-button" %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="text-center">
    <%= link_to "é€šå ±ä¸€è¦§ã¸",admin_reports_path %>
  </div>
</div>
```

## æœ€å¾Œã«
ä»¥ä¸ŠãŒé€šå ±æ©Ÿèƒ½ã®æ¦‚è¦ã«ãªã‚Šã¾ã™ã€‚
æ™‚é–“ãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã®ã¨ã“ã‚ã«ã‚‚eunmã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚








